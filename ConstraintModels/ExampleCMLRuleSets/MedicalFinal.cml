/*
 * =====================================================
 * DO NOT MODIFY
 * =====================================================
 * Gold Standard CML Constraint Model for Medical Product
 * =====================================================
 */
@(contextPath = "SalesTransaction.UserProfile", attributeSource = "ST")
extern string UserProfile;

type FamilyHealthInsurance {
    relation primarymember : PrimaryMember[1];
}


type Member {
    @(configurable=false)
    string First_Name;

    @(configurable=false)
    string Last_Name;

    @(configurable=false, domainComputation=false)
    int Age = [0..100];

    string E_Mail;

    string State;

    @(configurable = false, domainComputation = false)
    string Marital_Status = ["Unmarried", "Married", "Single", "None"];

    @(configurable=false, defaultValue = "Male",domainComputation = false)
    string Gender = ["Male", "Female", "Others"];
}


type PrimaryMember : Member {

    message(Last_Name == "" || Last_Name == null, "Contact/Patient Record is required!", "Error");
    
    @(closeRelation=true, propagateUp=true, sequence=1)
    relation dependentmember : Member {
        dependentMemberMaxAge = max(Age);
        dependentMemberMarriedMaritalStatusCount = count(Marital_Status == 'Married');
        dependentMemberSingleMaritalStatusCount = count(Marital_Status == 'Single');
    }
    @(sequence=1)
    relation preventivecarewellness : PreventiveCareWellness[0..1];
    
    @(sequence=1)
    relation outpatient : OutPatient[0..1];
    
    @(sequence=2)
    relation criticalillnesssurgery : CriticalIllnessSurgery[0..1];
    
    @(sequence=2)
    relation chronicdisease : ChronicDisease[0..1];


    // constraint #1
    boolean isClause1 = (Age >= 40 && Gender == "Male") || (Marital_Status == "Married");
     
    require(isClause1 &&  outpatient[OutPatient] > 0, preventivecarewellness[PreventiveCareWellness]{Deductible_Limit = 5000}, 
    	"If primary member is 40 years old plus male or married, and has out patient coverage, auto Add PreventiveCareWelness");
    message(isClause1 &&  outpatient[OutPatient] > 0, 
    	"If primary member is 40 years old plus male or married, and has out patient coverage, auto Add PreventiveCareWelness");
    
    require(isClause1 &&  outpatient[OutPatient] > 0, chronicdisease[ChronicDisease], "If primary member is 40 years old plus male or married, and has out patient coverage, auto Add Chronic Disease Coverage");
    message(isClause1 &&  outpatient[OutPatient] > 0, "If primary member is 40 years old plus male or married, and has out patient coverage, auto Add Chronic Disease Coverage");
    
    int primarymemberPCWOut_Network_Deductible_Limit = preventivecarewellness[PreventiveCareWellness].Out_Network_Deductible_Limit;

    // constraint #2
    boolean isClause2 = (Gender == 'Female') && (UserProfile == "System Administrator") && (dependentmember.dependentMemberSingleMaritalStatusCount > 0);
    exclude((Gender == 'Female') && (UserProfile == "System Administrator") && (dependentmember.dependentMemberSingleMaritalStatusCount > 0), criticalillnesssurgery[CriticalIllnessSurgery],"remove and disable primary member's Critical Illness Surgery'coverage");

    // constraint #4
    boolean primaryMemberHasOutPatient = outpatient[OutPatient] > 0;
    constraint(outpatient[OutPatient] > 0 && UserProfile == "System Administrator" -> outpatient.Doctor_visit_copay == 10000, "If OP cover then set Doctor visit to 10k");

    // constraint #5
    require(Age > 40 && dependentmember.dependentMemberMaxAge < 30, chronicdisease[ChronicDisease], "Auto Add ChronicDisease for Primary member");
}


type DependentMember : Member {
    message(Last_Name == "" || Last_Name == null, "Contact/Patient Record is required!", "Error");
    
    relation dependentoutpatient : OutPatient[0..1];

    relation dependentpreventivecarewellness : PreventiveCareWellness[0..1];

    relation dependentchronicdisease : ChronicDisease[0..1];

    relation dependentcriticalillnesssurgery : CriticalIllnessSurgery[0..1];

    string primaryMemberMaritalStatus = parent(Marital_Status);

    int primmemberONDL = parent(primarymemberPCWOut_Network_Deductible_Limit);

    int primaryMemberAge = parent(Age);

    // constraint #2
    boolean parentIsClause2 = parent(isClause2);
    rule(parentIsClause2, "hide", "attribute", "Gender", "value", "Others");
    require(parentIsClause2, dependentcriticalillnesssurgery[CriticalIllnessSurgery], "Auto add dep member critical illness surgery");

    boolean primaryMemberHasOutPatient = parent(primaryMemberHasOutPatient);

    // constraint #3
    require((Age < 30 && primmemberONDL >= 250), dependentpreventivecarewellness[PreventiveCareWellness] {Annual_Out_of_Pocket_Limit = 20000},"Preventive Care Is Required OOPM is set to 20k");
    
    // Rule5
    require(primaryMemberAge > 40 && Age < 30, dependentoutpatient[OutPatient], "Autoadd out patient cov for depmember");
    message(primaryMemberAge > 40 && Age < 30, "Autoadd outpatient cov for depmember");
    
    // Rule4
    require(primaryMemberHasOutPatient && UserProfile == "System Administrator", dependentchronicdisease[ChronicDisease], "Autoadd chronic disease cov for dependent member");
    message(primaryMemberHasOutPatient && UserProfile == "System Administrator", "Autoadd chronic disease cov for dependent member");
}


@(split = false)
type CriticalIllnessSurgery {
    @(configurable=false)
    int Out_Network_Diagnostic_lab_test_copay;
    @(defaultValue="50", domainComputation=false)
    int Out_Network_Deductible_Limit = [0, 25, 50, 75, 100, 150, 200, 250, 300, 350, 400, 450, 500];

    @(defaultValue = "3000")
    int Out_Network_Limit;
    @(defaultValue = "0")
    int Out_Network_coinsurance;
    @(domainComputation=false)
    int Out_Network_Annual_Out_of_Pocket_Limit = [0, 100, 500, 1000];

    @(domainComputation=false)
    int Out_Network_Doctor_visit_copay = [0, 10, 50, 100];

    @(defaultValue="5", domainComputation=false)
    int Deductible_Limit = [0, 5, 100, 200,5000];

    @(domainComputation=false)
    int Annual_Out_of_Pocket_Limit = [0, 5000, 10000, 20000];

    string ICU_Fees;

    string Room_Rent_limit;

    @(domainComputation = false)
    int Doctor_visit_copay = [0, 10, 25, 10000];

    @(defaultValue = "60", domainComputation = false)
    int Number_of_days_covered = [0, 30, 60];
}

@(split = false)
type ChronicDisease {
    @(configurable=false)
    int Out_Network_Diagnostic_lab_test_copay;
    @(defaultValue = "50", domainComputation = false)
    int Out_Network_Deductible_Limit = [0, 25, 50, 75, 100, 150, 200, 250, 300, 350, 400, 450, 500];

    @(defaultValue = "3000")
    int Out_Network_Limit;
    @(defaultValue = "0")
    int Out_Network_coinsurance;
    @(domainComputation = false)
    int Out_Network_Annual_Out_of_Pocket_Limit = [0, 100, 500, 1000];

    string Out_Network_Room_Rent_limit;
    string Out_Network_ICU_Fees;
    @(defaultValue = "30")
    int Out_Network_Number_of_days_covered;
    @(domainComputation = false)
    int Out_Network_Doctor_visit_copay = [0, 10, 50, 100];

    @(defaultValue = "5", domainComputation = false)
    int Deductible_Limit = [0, 5, 100, 200,5000];

    @(domainComputation = false)
    int Annual_Out_of_Pocket_Limit = [0, 5000, 10000, 20000];

    string ICU_Fees;

    string Room_Rent_limit;

    @(configurable=false)
    int Diagnostic_lab_test_copay;
    @(defaultValue = "0")
    int coinsurance;
    @(defaultValue = "5000")
    int Medical_Limit;
    @(domainComputation = false)
    int Doctor_visit_copay = [0, 10, 25, 10000];

    @(defaultValue = "60", domainComputation = false)
    int Number_of_days_covered = [0, 30, 60];
}

@(split = false)
type PreventiveCareWellness {
    @(configurable=false)
    int Out_Network_Diagnostic_lab_test_copay;
    @(defaultValue = "50", domainComputation = false)
    int Out_Network_Deductible_Limit = [0, 25, 50, 75, 100, 150, 200, 250, 300, 350, 400, 450, 500];

    @(defaultValue = "3000")
    int Out_Network_Limit;
    @(defaultValue = "0")
    int Out_Network_coinsurance;
    @(domainComputation = false)
    int Out_Network_Annual_Out_of_Pocket_Limit = [0, 100, 500, 1000];

    string Out_Network_Room_Rent_limit;
    string Out_Network_ICU_Fees;
    @(defaultValue = "30", domainComputation = false)
    int Out_Network_Number_of_days_covered;
    @(domainComputation = false)
    int Out_Network_Doctor_visit_copay = [0, 10, 50, 100];
    @(configurable=false)
    int Out_Network_Copay;
    @(defaultValue = "5", domainComputation = false)
    int Deductible_Limit = [0, 5, 100, 200,5000];

    @(domainComputation = false)
    int Annual_Out_of_Pocket_Limit = [0, 5000, 10000, 20000];

    string ICU_Fees;

    string Room_Rent_limit;

    @(defaultValue = 0)
    int Diagnostic_lab_test_copay;
    
    @(defaultValue = "0")
    int coinsurance;
    
    @(defaultValue = "5000")
    int Medical_Limit;
    @(domainComputation = false)
    int Doctor_visit_copay = [0, 10, 25, 10000];

    @(defaultValue = "60", domainComputation = false)
    int Number_of_days_covered = [0, 10, 30, 60];
}

@(split = false)
type OutPatient {
    @(configurable=false)
    int Out_Network_Diagnostic_lab_test_copay;
    @(defaultValue = "50")
    int Out_Network_Deductible_Limit = [0, 25, 50, 75, 100, 150, 200, 250, 300, 350, 400, 450, 500];

    @(defaultValue = "3000")
    int Out_Network_Limit;
    @(defaultValue = "0")
    int Out_Network_coinsurance;
    @(domainComputation = false)
    int Out_Network_Annual_Out_of_Pocket_Limit = [0, 100, 500, 1000];

    string Out_Network_Room_Rent_limit;
    string Out_Network_ICU_Fees;
    @(defaultValue = "30")
    int Out_Network_Number_of_days_covered;
    @(domainComputation = false)
    int Out_Network_Doctor_visit_copay = [0, 10, 50, 100];
    @(configurable=false)
    int Out_Network_Copay;
    @(defaultValue = "50", domainComputation = false)
    int Deductible_Limit = [0, 5, 50, 100, 200,5000];

    @(domainComputation = false)
    int Annual_Out_of_Pocket_Limit = [0, 5000, 10000, 20000];

    string ICU_Fees;

    string Room_Rent_limit;

    @(configurable = false)
    int Diagnostic_lab_test_copay;
    @(defaultValue = "0")
    int coinsurance;
    @(defaultValue = "5000")
    int Medical_Limit;
    @(domainComputation = false)
    int Doctor_visit_copay = [0, 10, 25, 10000];

    @(defaultValue = "60")
    int Number_of_days_covered = [0, 30, 60];

    // Rule2
    boolean getClauseFlag = parent(parentIsClause2);
    boolean parenthasOutPatient = parent(primaryMemberHasOutPatient);
    rule(getClauseFlag && parenthasOutPatient, "hide", "attribute", "Out_Network_Copay");
}